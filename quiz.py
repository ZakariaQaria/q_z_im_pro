import streamlit as st
import random
from achievements import add_achievement

def show_quiz():
    """ุนุฑุถ ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู"""
    
    st.header("๐ ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู - ูุนุงูุฌุฉ ุงูุตูุฑ")
    st.markdown("ุงุฎุชุจุฑ ูุนุฑูุชู ุงููุงููุฉ ูู ูุนุงูุฌุฉ ุงูุตูุฑ ูู ุฎูุงู ูุฐุง ุงูุงุฎุชุจุงุฑ ุงูุดุงูู.")
    
    if 'quiz_submitted' not in st.session_state:
        st.session_state.quiz_submitted = False
        st.session_state.quiz_score = 0
        st.session_state.quiz_answers = {}
    
    # ุงูุฃุณุฆูุฉ ูุน ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ
    questions = [
        {
            "id": 1,
            "question": "ูุง ูู ุงูุจูุณู ูู ุงูุตูุฑุฉ ุงูุฑูููุฉุ",
            "options": [
                "ุฃุตุบุฑ ูุญุฏุฉ ูู ุงูุตูุฑุฉ ุงูุฑูููุฉ",
                "ููุน ูู ุฃููุงุน ุงูููุงุชุฑ",
                "ุฃุฏุงุฉ ูููุงุณ ุฌูุฏุฉ ุงูุตูุฑุฉ",
                "ุจุฑูุงูุฌ ููุนุงูุฌุฉ ุงูุตูุฑ"
            ],
            "correct": 0,
            "points": 2
        },
        {
            "id": 2,
            "question": "ูู ููุงุฉ ููููุฉ ูู ูุธุงู ุงูุฃููุงู RGBุ",
            "options": ["1", "2", "3", "4"],
            "correct": 2,
            "points": 2
        },
        {
            "id": 3,
            "question": "ุฃู ูู ูุฐู ุงูุนูููุงุช ุชุณุชุฎุฏู ููุดู ุงูุญูุงูุ",
            "options": [
                "ุงูุชุญููู ุฅูู ุงูุฑูุงุฏู",
                "ุชุทุจูู ููุชุฑ Gaussian",
                "ูุดู Canny",
                "ุงูุนูููุงุช ุงูููุฑููููุฌูุฉ"
            ],
            "correct": 2,
            "points": 3
        },
        {
            "id": 4,
            "question": "ูุง ูู ุงูุบุฑุถ ูู ุงูุนูููุงุช ุงูููุฑููููุฌูุฉุ",
            "options": [
                "ุชุญุณูู ุฃููุงู ุงูุตูุฑุฉ",
                "ูุนุงูุฌุฉ ุฃุดูุงู ุงูุฃุฌุณุงู ูู ุงูุตูุฑุฉ ุงูุซูุงุฆูุฉ",
                "ุฅุถุงูุฉ ุชุฃุซูุฑุงุช ูููุฉ ููุตูุฑุฉ",
                "ุฒูุงุฏุฉ ุฏูุฉ ุงูุตูุฑุฉ"
            ],
            "correct": 1,
            "points": 3
        },
        {
            "id": 5,
            "question": "ูุง ุงููุฑู ุจูู ุงูุชุขูู ูุงูุชูุฏุฏ ูู ุงูุนูููุงุช ุงูููุฑููููุฌูุฉุ",
            "options": [
                "ุงูุชุขูู ููุณุน ุงูุฃุดูุงุก ูุงูุชูุฏุฏ ูุถูููุง",
                "ุงูุชูุฏุฏ ููุณุน ุงูุฃุดูุงุก ูุงูุชุขูู ูุถูููุง",
                "ููุงููุง ูููุง ููุณ ุงูุชุฃุซูุฑ",
                "ุงูุชุขูู ููุตูุฑ ุงูููููุฉ ูุงูุชูุฏุฏ ููุฑูุงุฏูุฉ"
            ],
            "correct": 1,
            "points": 4
        },
        {
            "id": 6,
            "question": "ุฃู ูู ูุฐู ุงูุฎูุงุฑุฒููุงุช ุชุนุชุจุฑ ุงูุฃูุถู ููุดู ุงูุญูุงูุ",
            "options": ["Sobel", "Prewitt", "Laplacian", "Canny"],
            "correct": 3,
            "points": 3
        },
        {
            "id": 7,
            "question": "ูุง ูู ูุธุงู ุงูุฃููุงู HSVุ",
            "options": [
                "ูุธุงู ุฃููุงู ููุทุจุงุนุฉ",
                "ูุธุงู ุฃููุงู ูุนุชูุฏ ุนูู ุงูุตุจุบุฉ ูุงูุฅุดุจุงุน ูุงููููุฉ",
                "ูุธุงู ุฃููุงู ููุตูุฑ ุงูุทุจูุฉ",
                "ูุธุงู ุฃููุงู ูุฏูู"
            ],
            "correct": 1,
            "points": 3
        },
        {
            "id": 8,
            "question": "ูุง ูู ุงูุชุญููู ุงูุฃูููู (Affine Transform)ุ",
            "options": [
                "ุชุญููู ูุญุงูุธ ุนูู ุงูุฎุทูุท ุงููุชูุงุฒูุฉ",
                "ุชุญููู ูุญุงูุธ ุนูู ุงูุฒูุงูุง ููุท",
                "ุชุญููู ููุตูุฑ ุงูููููุฉ ููุท",
                "ุชุญููู ููุตูุฑ ุงูุฑูุงุฏูุฉ ููุท"
            ],
            "correct": 0,
            "points": 4
        },
        {
            "id": 9,
            "question": "ูุง ูู ุงูุบุฑุถ ูู ุฅุฒุงูุฉ ุงูุถูุถุงุก ูู ุงูุตูุฑุ",
            "options": [
                "ุฒูุงุฏุฉ ุญุฌู ุงูุตูุฑุฉ",
                "ุชุญุณูู ุฌูุฏุฉ ุงูุตูุฑุฉ ูุฅุฒุงูุฉ ุงูุชุดููุด",
                "ุชุบููุฑ ุฃููุงู ุงูุตูุฑุฉ",
                "ุฅุถุงูุฉ ุชุฃุซูุฑุงุช ูููุฉ"
            ],
            "correct": 1,
            "points": 2
        },
        {
            "id": 10,
            "question": "ูุง ูู ุทุฑููุฉ Bicubic Interpolationุ",
            "options": [
                "ุฃุณุฑุน ุทุฑููุฉ ููุงุณุชููุงุก",
                "ุฃุฏู ุทุฑููุฉ ููุงุณุชููุงุก ูููููุง ุจุทูุฆุฉ",
                "ุทุฑููุฉ ูููุดู ุนู ุงูุญูุงู",
                "ุทุฑููุฉ ููุชุญููู ุฅูู ุงูุฑูุงุฏู"
            ],
            "correct": 1,
            "points": 4
        }
    ]
    
    if not st.session_state.quiz_submitted:
        with st.form("quiz_form"):
            st.subheader("ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู - 10 ุฃุณุฆูุฉ")
            st.info("ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ููู ุณุคุงู. ุงูุฅุฌูุงูู: 30 ููุทุฉ")
            
            user_answers = {}
            
            for i, q in enumerate(questions):
                st.markdown(f"**ุงูุณุคุงู {i+1}: {q['question']}** ({q['points']} ููุงุท)")
                
                # ุนุฑุถ ุงูุฎูุงุฑุงุช ุจุดูู ุนุดูุงุฆู
                options = q['options']
                random_seed = q['id'] + st.session_state.get('user_id', 0)
                random.Random(random_seed).shuffle(options)
                
                user_answers[q['id']] = st.radio(
                    f"ุงูุงุฎุชูุงุฑุงุช_{q['id']}",
                    options,
                    key=f"q_{q['id']}",
                    label_visibility="collapsed",
                    index=None
                )
                st.markdown("---")
            
            submitted = st.form_submit_button("๐ค ุชูุฏูู ุงูุฅุฌุงุจุงุช")
            
            if submitted:
                # ุงูุชุญูู ูู ุฅุฌุงุจุฉ ุฌููุน ุงูุฃุณุฆูุฉ
                if any(answer is None for answer in user_answers.values()):
                    st.error("โ๏ธ ูุฑุฌู ุงูุฅุฌุงุจุฉ ุนูู ุฌููุน ุงูุฃุณุฆูุฉ")
                    return
                
                st.session_state.quiz_submitted = True
                st.session_state.quiz_answers = user_answers
                
                # ุชุตุญูุญ ุงูุฅุฌุงุจุงุช
                score = 0
                correct_answers = 0
                
                for q in questions:
                    user_answer = user_answers[q['id']]
                    correct_answer = q['options'][q['correct']]
                    
                    if user_answer == correct_answer:
                        score += q['points']
                        correct_answers += 1
                
                st.session_state.quiz_score = score
                
                # ุนุฑุถ ุงููุชุงุฆุฌ
                st.success(f"**ุงููุชูุฌุฉ: {score}/30**")
                st.progress(score / 30)
                
                # ุชูููู ุงูุฃุฏุงุก
                if score >= 25:
                    st.balloons()
                    st.success("๐ ููุชุงุฒ! ุฃุฏุงุก ุฑุงุฆุน")
                    add_achievement("ุฎุจูุฑ ูุนุงูุฌุฉ ุงูุตูุฑ", "ุงูุญุตูู ุนูู ุฏุฑุฌุฉ ููุชุงุฒุฉ ูู ุงูุงุฎุชุจุงุฑ")
                elif score >= 20:
                    st.success("๐ ุฌูุฏ ุฌุฏุงู!")
                elif score >= 15:
                    st.info("๐ ุฌูุฏ")
                else:
                    st.warning("๐ ุชุญุชุงุฌ ุฅูู ูุฒูุฏ ูู ุงูุฏุฑุงุณุฉ")
                
                # ุนุฑุถ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ
                with st.expander("๐ ุนุฑุถ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ", expanded=False):
                    for q in questions:
                        st.markdown(f"**ุงูุณุคุงู {q['id']}:** {q['question']}")
                        st.markdown(f"**ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ:** {q['options'][q['correct']]}")
                        st.markdown("---")
                
                # ุชุญุฏูุซ ููุงุท ุงููุณุชุฎุฏู
                st.session_state.user_xp += score
                if score >= 24:
                    add_achievement("ุณูุฏ ุงูุงุฎุชุจุงุฑุงุช", "ุงูุญุตูู ุนูู 24+ ููุทุฉ ูู ุงูุงุฎุชุจุงุฑ ุงูููุงุฆู")
    
    else:
        # ุนุฑุถ ุงููุชุงุฆุฌ ุจุนุฏ ุงูุชูุฏูู
        st.success(f"**ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: {st.session_state.quiz_score}/30**")
        
        if st.button("๐ ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ"):
            st.session_state.quiz_submitted = False
            st.session_state.quiz_score = 0
            st.session_state.quiz_answers = {}
            st.rerun()

def get_quiz_score():
    """ุงูุญุตูู ุนูู ูุชูุฌุฉ ุงูุงุฎุชุจุงุฑ"""
    return st.session_state.get('quiz_score', 0)

def is_quiz_passed():
    """ุงูุชุญูู ุฅุฐุง ุชู ุงุฌุชูุงุฒ ุงูุงุฎุชุจุงุฑ"""
    return st.session_state.get('quiz_score', 0) >= 18  # 60% ูุญุฏ ุฃุฏูู